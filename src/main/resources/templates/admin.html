<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      th:with="lang=${#locale.language}, rtl=${lang == 'ar' or lang == 'he'}"
      th:lang="${lang}"
      th:dir="${rtl} ? 'rtl' : 'ltr'">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{admin.pageTitle}">Admin Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

    <style>
        body{
            font-family:'Cairo',sans-serif;
            background:#f6f7f9;
            color:#222;
        }

        .wrap{ max-width: 1100px; }

        .topbar{
            background:#fff;
            padding: 28px 0 18px;
            border-bottom:1px solid #e5e7eb;
        }
        .brand{
            display:flex; align-items:center; justify-content:center; gap:10px;
            font-weight:900; color:#111;
        }
        .brand i{ color:#3b82f6; }
        .subtitle{
            text-align:center;
            color:#6b7280;
            margin-top:6px;
            font-size:.95rem;
        }

        .card-pro{
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius:20px;
            box-shadow:0 6px 25px rgba(0,0,0,.05);
        }

        .section-h{
            display:flex; align-items:center; justify-content:space-between;
            gap:10px;
            margin-bottom:14px;
        }
        .section-title{
            display:flex; align-items:center; gap:10px;
            font-weight:900; color:#111;
            margin:0;
        }
        .section-title i{ color:#3b82f6; }

        .note{ font-size:.9rem; color:#6b7280; }

        .form-label{
            font-weight:800;
            color:#111;
        }

        .form-control{
            border-radius:14px;
            padding:12px;
            border:1px solid #e5e7eb;
            background:#fff;
        }
        .form-control:focus{
            border-color:#3b82f6;
            box-shadow:0 0 0 3px rgba(59,130,246,.15);
        }

        .btn-outline-clean{
            border-radius:14px;
            font-weight:900;
            border:1px solid #cbd5e1;
            background:#fff;
            color:#111;
            padding:10px 14px;
            text-decoration:none;
        }
        .btn-outline-clean:hover{ background:#f1f5f9; }

        .stats-grid{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
        }
        @media (max-width: 768px){
            .stats-grid{ grid-template-columns: 1fr; }
        }
        .stat-card{
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius:18px;
            padding: 16px;
            box-shadow:0 6px 25px rgba(0,0,0,.05);
            display:flex;
            align-items:center;
            justify-content:space-between;
        }
        .stat-left{
            display:flex; align-items:center; gap:12px;
        }
        .stat-icon{
            width:44px;
            height:44px;
            border-radius:14px;
            display:flex;
            align-items:center;
            justify-content:center;
            background:#eff6ff;
            border:1px solid #bfdbfe;
        }
        .stat-icon i{ color:#1d4ed8; font-size:16px; }
        .stat-title{
            margin:0;
            font-weight:900;
            color:#111;
        }
        .stat-sub{
            margin:2px 0 0;
            color:#6b7280;
            font-size:.9rem;
            font-weight:600;
        }
        .stat-number{
            font-size: 2.4rem;
            font-weight: 900;
            color:#111;
            line-height:1;
        }

        .table-wrap{
            background:#fff;
            border:1px solid #e5e7eb;
            border-radius:18px;
            overflow:hidden;
        }
        .table{ margin:0; }

        .table thead th{
            background:#f8fafc !important;
            color:#111 !important;
            border-bottom:1px solid #e5e7eb !important;
            font-weight:900;
            white-space:nowrap;
        }
        .table td{
            border-top:1px solid #eef2f7 !important;
            vertical-align:middle;
            white-space:nowrap;
            color:#111 !important;
        }

        .badge-status{
            background:#ecfdf5;
            border:1px solid #a7f3d0;
            color:#166534;
            padding:7px 10px;
            border-radius:999px;
            font-weight:900;
            font-size:.85rem;
            display:inline-block;
        }

        .btn-danger-soft{
            background:#fff1f2;
            border:1px solid #fecdd3;
            color:#9f1239;
            border-radius:14px;
            padding:8px 12px;
            font-weight:900;
        }
        .btn-danger-soft:hover{ background:#ffe4e6; }

        .empty{
            color:#6b7280;
            text-align:center;
            padding: 18px 10px;
        }

        [dir="rtl"] .ms-2{ margin-left: .5rem !important; margin-right: 0 !important; }
        [dir="ltr"] .ms-2{ margin-right: .5rem !important; margin-left: 0 !important; }
    </style>
</head>

<body>

<div class="topbar">
    <div class="container wrap">
        <div class="brand">
            <i class="fa-solid fa-user-shield"></i>
            <div th:text="#{admin.title}">Admin Dashboard</div>
        </div>
        <div class="subtitle" th:text="#{admin.subtitle}">Manage bookings and days off</div>
    </div>
</div>

<div class="text-center my-3">
    <a th:href="@{/admin/services}" class="btn btn-primary btn-lg" th:text="#{admin.manageServices}">
        Manage Services
    </a>
    <a th:href="@{/admin/settings}" class="btn btn-dark" th:text="#{admin.linkSettings}">
        ⚙️ Link Settings
    </a>
</div>

<div class="container py-4 wrap">

    <div class="card card-pro p-4 mb-3">
        <div class="section-h">
            <h5 class="section-title">
                <i class="fa-solid fa-calendar-days"></i>
                <span th:text="#{admin.chooseDateTitle}">Choose date</span>
            </h5>

            <a th:href="@{/}" class="btn btn-outline-clean">
                <i class="fa-solid fa-house ms-2"></i>
                <span th:text="#{nav.home}">Home</span>
            </a>
        </div>

        <form method="get" action="/admin" id="adminAutoForm">
            <label class="form-label" th:text="#{admin.date}">Date</label>
            <input class="form-control"
                   type="date"
                   name="date"
                   id="adminDateInput"
                   th:value="${selectedDate}">
            <div class="note mt-2" th:text="#{admin.autoRefreshNote}">
                Page refreshes automatically when date changes.
            </div>
        </form>
    </div>

    <div class="stats-grid mb-3">
        <div class="stat-card">
            <div class="stat-left">
                <div class="stat-icon"><i class="fa-regular fa-sun"></i></div>
                <div>
                    <p class="stat-title" th:text="#{admin.stats.today}">Today bookings</p>
                    <p class="stat-sub" th:text="#{admin.stats.todaySub}">Bookings count for this day</p>
                </div>
            </div>
            <div class="stat-number" th:text="${dailyCount}">0</div>
        </div>

        <div class="stat-card">
            <div class="stat-left">
                <div class="stat-icon"><i class="fa-regular fa-calendar"></i></div>
                <div>
                    <p class="stat-title" th:text="#{admin.stats.week}">This week bookings</p>
                    <p class="stat-sub" th:text="#{admin.stats.weekSub}">Bookings count in 7 days</p>
                </div>
            </div>
            <div class="stat-number" th:text="${weeklyCount}">0</div>
        </div>
    </div>

    <div class="card card-pro p-3 p-md-4">
        <div class="section-h">
            <h5 class="section-title">
                <i class="fa-solid fa-list"></i>
                <span th:text="#{admin.table.title}">Appointments</span>
            </h5>
            <div class="note" th:text="#{admin.table.hint}">Shows appointments for selected date</div>
        </div>

        <div class="table-wrap">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                    <tr>
                        <th th:text="#{admin.table.time}">Time</th>
                        <th th:text="#{admin.table.service}">Service</th>
                        <th th:text="#{admin.table.duration}">Duration</th>
                        <th th:text="#{admin.table.name}">Name</th>
                        <th th:text="#{admin.table.phone}">Phone</th>
                        <th th:text="#{admin.table.status}">Status</th>
                        <th th:text="#{admin.table.delete}">Delete</th>
                    </tr>
                    </thead>

                    <tbody>
                    <tr th:if="${appointments == null || #lists.isEmpty(appointments)}">
                        <td colspan="7" class="empty" th:text="#{admin.table.empty}">No appointments.</td>
                    </tr>

                    <tr th:each="a : ${appointments}">
                        <td th:text="${#temporals.format(a.startTime, 'HH:mm')}">10:00</td>

                        <td th:text="${
                                (lang == 'he'
                                 ? (a.service.nameHe != null && !a.service.nameHe.isBlank() ? a.service.nameHe : a.service.nameAr)
                                 : (lang == 'en'
                                    ? (a.service.nameEn != null && !a.service.nameEn.isBlank() ? a.service.nameEn : a.service.nameAr)
                                    : a.service.nameAr)
                                )
                            }">Service</td>

                        <td th:text="${a.service.durationMinutes + ' ' + #messages.msg('minutes')}">25 minutes</td>
                        <td th:text="${a.customerName}">Ahmed</td>
                        <td th:text="${a.phone}">05xxxxxxxx</td>
                        <td><span class="badge-status" th:text="${a.status}">BOOKED</span></td>

                        <td>
                            <!-- ✅ FIXED: no th:onsubmit -->
                            <form method="post" action="/admin/delete"
                                  class="confirm-form"
                                  th:attr="data-confirm=#{admin.confirmDelete}">
                                <input type="hidden" name="id" th:value="${a.id}">
                                <input type="hidden" name="date" th:value="${selectedDate}">
                                <button type="submit" class="btn-danger-soft" th:text="#{admin.table.deleteBtn}">
                                    Delete
                                </button>
                            </form>
                        </td>
                    </tr>
                    </tbody>

                </table>
            </div>
        </div>
    </div>

</div>

<script>
    const adminDateInput = document.getElementById('adminDateInput');
    const adminAutoForm = document.getElementById('adminAutoForm');

    function autoSubmitAdmin(){
        adminAutoForm.submit();
    }
    adminDateInput.addEventListener('change', autoSubmitAdmin);
</script>

<!-- ✅ Confirm handler (for delete forms) -->
<script>
    document.addEventListener('submit', function (e) {
      const form = e.target.closest('.confirm-form');
      if (!form) return;

      const msg = form.getAttribute('data-confirm') || 'Are you sure?';
      if (!confirm(msg)) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
</script>

</body>
</html>